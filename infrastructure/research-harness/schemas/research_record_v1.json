{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://cascadia-mobile-lab/schemas/research_record_v1.json",
  "title": "ResearchRecord",
  "description": "Cascadia Mobile Systems Lab Research Record v1. Unifies methodological systems research output with hardware telemetry captured during execution.",
  "type": "object",
  "required": [
    "run_id",
    "schema_version",
    "created_at",
    "status",
    "research",
    "model",
    "node",
    "runtime",
    "reproducibility"
  ],
  "additionalProperties": false,
  "properties": {

    "run_id": {
      "type": "string",
      "format": "uuid",
      "description": "Universally unique identifier for this research run. Primary key and foreign key for all telemetry systems."
    },

    "schema_version": {
      "type": "string",
      "enum": ["1.0"],
      "description": "Schema version for forward-compatible evolution."
    },

    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when the research task was created."
    },

    "completed_at": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "ISO 8601 timestamp when the research task completed. Null if not yet complete."
    },

    "status": {
      "type": "string",
      "enum": ["pending", "running", "completed", "failed", "cancelled"],
      "description": "Lifecycle status of the research run."
    },

    "research": {
      "type": "object",
      "description": "Methodological fields: the research question, plan, retrieved evidence, synthesis, and self-critique.",
      "required": ["question", "question_hash"],
      "properties": {

        "question": {
          "type": "string",
          "minLength": 10,
          "description": "The research question posed to the system."
        },

        "question_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "SHA-256 hash of the normalized question text for deduplication and longitudinal tracking."
        },

        "hypotheses": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Hypotheses generated in the decomposition phase."
        },

        "plan": {
          "type": "array",
          "description": "Research plan steps generated by the decompose phase.",
          "items": {
            "type": "object",
            "required": ["step", "phase", "description"],
            "properties": {
              "step":         {"type": "integer", "minimum": 1},
              "phase":        {"type": "string", "enum": ["retrieval", "analysis", "synthesis", "critique"]},
              "description":  {"type": "string"},
              "search_query": {"type": ["string", "null"]}
            }
          }
        },

        "retrieval": {
          "type": ["object", "null"],
          "description": "Retrieval strategy and source list with integrity hashes.",
          "properties": {
            "strategy":       {"type": "string"},
            "queries_issued": {"type": "integer", "minimum": 0},
            "sources": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["source_id", "type", "title", "retrieved_at", "content_hash"],
                "properties": {
                  "source_id":        {"type": "string"},
                  "type":             {"type": "string", "enum": ["web", "local_corpus", "api"]},
                  "url":              {"type": ["string", "null"]},
                  "path":             {"type": ["string", "null"]},
                  "title":            {"type": "string"},
                  "retrieved_at":     {"type": "string", "format": "date-time"},
                  "content_hash":     {"type": "string", "pattern": "^sha256:[a-f0-9]{64}$"},
                  "relevance_score":  {"type": ["number", "null"], "minimum": 0, "maximum": 1}
                }
              }
            }
          }
        },

        "evidence": {
          "type": ["array", "null"],
          "description": "Evidence items extracted from retrieved sources in the analyze phase.",
          "items": {
            "type": "object",
            "required": ["source_id", "claim", "confidence"],
            "properties": {
              "source_id":  {"type": "string"},
              "claim":      {"type": "string"},
              "confidence": {"type": "string", "enum": ["high", "medium", "low"]},
              "quote":      {"type": ["string", "null"]}
            }
          }
        },

        "synthesis": {
          "type": ["string", "null"],
          "description": "The main synthesized answer produced in the synthesis phase."
        },

        "limitations": {
          "type": ["array", "null"],
          "items": {"type": "string"},
          "description": "Explicitly stated limitations of the synthesis."
        },

        "self_critique": {
          "type": ["object", "null"],
          "description": "LLM self-evaluation of its own output.",
          "properties": {
            "assessment":           {"type": "string"},
            "confidence_overall":   {"type": "number", "minimum": 0, "maximum": 1},
            "gaps_identified":      {"type": "array", "items": {"type": "string"}}
          }
        }
      }
    },

    "model": {
      "type": "object",
      "description": "Model identity, version, and inference parameters.",
      "required": ["name", "tag", "backend", "parameters", "prompts"],
      "properties": {

        "name":              {"type": "string"},
        "version":           {"type": ["string", "null"]},
        "tag":               {"type": "string", "description": "Full Ollama model tag (e.g. mistral:7b-instruct-q4_K_M)"},
        "backend":           {"type": "string", "enum": ["ollama", "vllm", "llamacpp", "transformers"]},
        "quantization":      {"type": ["string", "null"]},
        "parameter_count_b": {"type": ["number", "null"]},
        "context_length":    {"type": ["integer", "null"]},

        "parameters": {
          "type": "object",
          "required": ["temperature", "seed"],
          "properties": {
            "temperature":    {"type": "number", "minimum": 0, "maximum": 2},
            "top_p":          {"type": ["number", "null"]},
            "top_k":          {"type": ["integer", "null"]},
            "seed":           {"type": "integer"},
            "max_tokens":     {"type": ["integer", "null"]},
            "num_ctx":        {"type": ["integer", "null"]},
            "repeat_penalty": {"type": ["number", "null"]}
          }
        },

        "prompts": {
          "type": "object",
          "required": ["system_prompt_hash", "prompt_hash", "prompt_template"],
          "properties": {
            "system_prompt_hash": {"type": "string", "pattern": "^sha256:[a-f0-9]{64}$"},
            "prompt_hash":        {"type": "string", "pattern": "^sha256:[a-f0-9]{64}$"},
            "prompt_template":    {"type": "string"},
            "prompt_token_count": {"type": ["integer", "null"]}
          }
        },

        "tool_calls": {
          "type": ["array", "null"],
          "items": {
            "type": "object",
            "required": ["tool", "call_id"],
            "properties": {
              "tool":               {"type": "string"},
              "call_id":            {"type": "string"},
              "input":              {"type": "object"},
              "output_length_chars":{"type": ["integer", "null"]},
              "duration_ms":        {"type": ["number", "null"]}
            }
          }
        }
      }
    },

    "node": {
      "type": "object",
      "description": "Hardware identity and physical specifications of the executing node.",
      "required": ["node_id", "hostname", "tier", "os", "cpu_model", "ram_gb"],
      "properties": {
        "node_id":              {"type": "string"},
        "hostname":             {"type": "string"},
        "tier":                 {"type": "string", "enum": ["micro", "small", "medium", "large", "gpu"]},
        "os":                   {"type": "string"},
        "kernel":               {"type": ["string", "null"]},
        "architecture":         {"type": "string"},
        "cpu_model":            {"type": "string"},
        "cpu_generation":       {"type": ["string", "null"]},
        "cpu_cores_physical":   {"type": "integer"},
        "cpu_cores_logical":    {"type": "integer"},
        "cpu_base_clock_mhz":   {"type": ["integer", "null"]},
        "cpu_boost_clock_mhz":  {"type": ["integer", "null"]},
        "ram_gb":               {"type": "integer"},
        "ram_type":             {"type": ["string", "null"]},
        "ram_speed_mhz":        {"type": ["integer", "null"]},
        "ram_channels":         {"type": ["integer", "null"]},
        "disk_type":            {"type": ["string", "null"], "enum": ["HDD", "SSD", "NVMe", null]},
        "disk_model":           {"type": ["string", "null"]},
        "disk_capacity_gb":     {"type": ["integer", "null"]},
        "gpu":                  {
          "oneOf": [
            {"type": "null"},
            {
              "type": "object",
              "required": ["model", "vram_gb"],
              "properties": {
                "model":            {"type": "string"},
                "vram_gb":          {"type": "number"},
                "driver_version":   {"type": ["string", "null"]},
                "cuda_version":     {"type": ["string", "null"]},
                "compute_cap":      {"type": ["string", "null"]},
                "utilization_pct":  {"type": ["number", "null"]},
                "temp_peak_c":      {"type": ["number", "null"]},
                "power_draw_w":     {"type": ["number", "null"]}
              }
            }
          ]
        },
        "network_interface":    {"type": ["string", "null"]},
        "network_speed_gbps":   {"type": ["number", "null"]}
      }
    },

    "runtime": {
      "type": "object",
      "description": "Timing, token counts, memory, CPU, thermal, network, and energy fields captured during execution.",
      "required": ["start_time", "tokens", "memory", "cpu"],
      "properties": {

        "start_time":           {"type": "string", "format": "date-time"},
        "end_time":             {"type": ["string", "null"], "format": "date-time"},
        "duration_seconds":     {"type": ["number", "null"]},
        "wall_clock_seconds":   {"type": ["number", "null"]},
        "inference_seconds":    {"type": ["number", "null"]},
        "retrieval_seconds":    {"type": ["number", "null"]},
        "overhead_seconds":     {"type": ["number", "null"]},

        "tokens": {
          "type": "object",
          "required": ["generated"],
          "properties": {
            "generated":      {"type": "integer", "minimum": 0},
            "per_second":     {"type": ["number", "null"]},
            "prompt_tokens":  {"type": ["integer", "null"]},
            "total_tokens":   {"type": ["integer", "null"]}
          }
        },

        "memory": {
          "type": "object",
          "properties": {
            "peak_rss_mb":            {"type": ["integer", "null"]},
            "peak_vms_mb":            {"type": ["integer", "null"]},
            "model_footprint_mb":     {"type": ["integer", "null"]},
            "swap_used_mb":           {"type": ["integer", "null"]},
            "swap_activity_detected": {"type": ["boolean", "null"]},
            "oom_kill_risk":          {"type": ["string", "null"], "enum": ["low", "medium", "high", null]}
          }
        },

        "cpu": {
          "type": "object",
          "properties": {
            "utilization_curve":      {
              "type": ["array", "null"],
              "items": {"type": "number", "minimum": 0, "maximum": 1},
              "description": "CPU utilization sampled at fixed interval (0.0â€“1.0)"
            },
            "curve_interval_seconds": {"type": ["number", "null"]},
            "mean_utilization":       {"type": ["number", "null"]},
            "peak_utilization":       {"type": ["number", "null"]},
            "idle_during_retrieval":  {"type": ["boolean", "null"]}
          }
        },

        "thermal": {
          "type": ["object", "null"],
          "properties": {
            "peak_cpu_temp_c":          {"type": ["number", "null"]},
            "throttling_detected":      {"type": ["boolean", "null"]},
            "throttling_duration_seconds": {"type": ["number", "null"]},
            "throttling_temp_threshold_c": {"type": ["number", "null"]},
            "fan_speed_rpm":            {"type": ["integer", "null"]}
          }
        },

        "network": {
          "type": ["object", "null"],
          "properties": {
            "bytes_sent":               {"type": "integer"},
            "bytes_received":           {"type": "integer"},
            "latency_to_controller_ms": {"type": ["number", "null"]}
          }
        },

        "energy": {
          "type": ["object", "null"],
          "description": "Energy consumption estimate. May be a hardware measurement (RAPL) or a proxy calculation.",
          "properties": {
            "method":          {"type": "string", "enum": ["rapl", "ipmi", "proxy", "unavailable"]},
            "proxy_basis":     {"type": ["string", "null"]},
            "cpu_tdp_w":       {"type": ["number", "null"]},
            "estimated_joules":{"type": ["number", "null"]},
            "confidence":      {"type": ["string", "null"], "enum": ["high", "medium", "low", null]},
            "note":            {"type": ["string", "null"]}
          }
        }
      }
    },

    "reproducibility": {
      "type": "object",
      "description": "Version and determinism metadata required to reproduce this run.",
      "required": ["harness_version", "deterministic", "seed_used"],
      "properties": {
        "harness_version":    {"type": "string"},
        "harness_commit":     {"type": ["string", "null"]},
        "config_hash":        {"type": ["string", "null"], "pattern": "^sha256:[a-f0-9]{64}$"},
        "ollama_version":     {"type": ["string", "null"]},
        "python_version":     {"type": ["string", "null"]},
        "environment_hash":   {"type": ["string", "null"], "pattern": "^sha256:[a-f0-9]{64}$"},
        "deterministic":      {"type": "boolean"},
        "seed_used":          {"type": "integer"}
      }
    },

    "evaluation": {
      "type": ["object", "null"],
      "description": "Post-hoc quality evaluation by a separate evaluator LLM pass. Null until evaluation completes.",
      "properties": {
        "evaluator_model":    {"type": "string"},
        "evaluator_run_id":   {"type": "string", "format": "uuid"},
        "evaluated_at":       {"type": "string", "format": "date-time"},
        "scores": {
          "type": "object",
          "properties": {
            "factual_grounding":        {"type": "number", "minimum": 0, "maximum": 1},
            "logical_coherence":        {"type": "number", "minimum": 0, "maximum": 1},
            "source_utilization":       {"type": "number", "minimum": 0, "maximum": 1},
            "limitations_acknowledged": {"type": "number", "minimum": 0, "maximum": 1},
            "self_critique_accuracy":   {"type": "number", "minimum": 0, "maximum": 1},
            "overall":                  {"type": "number", "minimum": 0, "maximum": 1}
          }
        },
        "evaluator_notes":    {"type": ["string", "null"]},
        "schema_version":     {"type": "string"}
      }
    }
  },

  "$defs": {
    "sha256_hash": {
      "type": "string",
      "pattern": "^sha256:[a-f0-9]{64}$"
    }
  }
}
