# Cascadia Mobile Systems Lab — Prometheus Configuration
# Version: 1.0
#
# Edit the scrape_configs.static_configs targets to reflect your
# actual node hostnames or IP addresses.
#
# For production, replace static_configs with file_sd_configs
# pointing to a generated targets file updated by the Controller API.

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  scrape_timeout: 10s

  # Labels added to all time-series from this Prometheus instance
  external_labels:
    cluster: 'cascadia-mobile-lab'
    region: 'local'

# -----------------------------------------------------------------
# Alert rules (loaded from files matching this pattern)
# -----------------------------------------------------------------
rule_files:
  - "rules/*.yml"

# -----------------------------------------------------------------
# Alertmanager integration
# -----------------------------------------------------------------
# alerting:
#   alertmanagers:
#     - static_configs:
#         - targets: ['cascadia-controller:9093']

# -----------------------------------------------------------------
# Scrape configurations
# -----------------------------------------------------------------
scrape_configs:

  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Node exporter — system metrics from all nodes
  # Add/remove targets as nodes are added to the cluster
  - job_name: 'node_exporter'
    static_configs:
      - targets:
          - 'cascadia-controller:9100'
          - 'cascadia-worker-01:9100'
          - 'cascadia-worker-02:9100'
          # Add more workers here
    relabel_configs:
      # Extract node_id from hostname for use as Prometheus label
      - source_labels: [__address__]
        regex: '([^:]+).*'
        target_label: 'node_id'
        replacement: '$1'
      - source_labels: [__address__]
        target_label: 'instance'

  # Research harness — per-worker Prometheus metrics (run-level)
  # These expose active run_id labels and per-run counters
  - job_name: 'research_harness'
    static_configs:
      - targets:
          - 'cascadia-worker-01:9091'
          - 'cascadia-worker-02:9091'
          # Add more workers here
    relabel_configs:
      - source_labels: [__address__]
        regex: '([^:]+).*'
        target_label: 'node_id'
        replacement: '$1'

  # Ollama inference backend metrics
  - job_name: 'ollama'
    static_configs:
      - targets:
          - 'cascadia-worker-01:11434'
          - 'cascadia-worker-02:11434'
    metrics_path: '/api/metrics'
    relabel_configs:
      - source_labels: [__address__]
        regex: '([^:]+).*'
        target_label: 'node_id'
        replacement: '$1'

  # PostgreSQL exporter (if installed on controller)
  # - job_name: 'postgresql'
  #   static_configs:
  #     - targets: ['cascadia-controller:9187']

  # Redis exporter (if installed on controller)
  # - job_name: 'redis'
  #   static_configs:
  #     - targets: ['cascadia-controller:9121']

# -----------------------------------------------------------------
# Remote write (optional — for long-term storage)
# -----------------------------------------------------------------
# remote_write:
#   - url: "http://thanos-receive:19291/api/v1/receive"
